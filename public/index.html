<!DOCTYPE html>
<html>
    <head>
        <title>Learn Arabic</title>
        <meta charset="utf-8">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Amiri&display=swap" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="style.css">
        <link rel="icon" type="image/x-icon" href="./img/favicon.ico">
    </head>
    <body>
        <template id="nahw-question-small-template">
            <style>

            </style>
            <div>
                <!-- <progress-view></progress-view> -->
                <!-- <nahw-text></nahw-text> -->
                <nahw-bar></nahw-bar>
            </div>
        </template>

        <template id="sentence-nav-template">
            <style>
                :root {
                    background: #fff;
                    secondary: #A6A6A6;
                    secondary-shadow: #E1E1E1;
                    primary: #42C62F;
                    primary-shadow: #489D26;
                }

                div {
                    background-color: var(--background);
                }

                button {
                    
                }

                .secondary {

                }
            </style>
            <div>
                <button class="secondary"><slot name="secondary">SECONDARY SLOT</slot></button>
                <button class="primary"><slot name="primary">PRIMARY SLOT</slot></button>
            </div>
        </template>
        <script type="text/javascript" src="cards.js"></script>
        <script type="text/javascript" src="nahw.js"></script>
        <script>
            function checkCardDuplicates(parentCard=null) {
                if (!parentCard) parentCard = cards;
                let queue = [];
                let ids = [];
                for (card of parentCard) {
                    if (ids.indexOf(card.id) !== -1) {
                        error(`The ID ${card.id} was used again in ${card.title}!`);
                        break;
                    }

                    if (card.display === "cards") {
                        queue.push(card);
                    }

                    ids.push(card.id);
                }
                while (queue.length !== 0) {
                    checkCardDuplicates(queue.shift());
                }
            }

            function error(msg) {
                console.error(msg);
                document.getElementById("error").innerHTML = msg;
            }

            function getIds() {
                const idStr = new URL(document.location).searchParams.get("id");
                if (idStr) {
                    return idStr.split("-");
                }
                return [];
            }

            function getCard(ids) {
                if (ids.length === 0) return null;
                let parentCard = {};
                parentCard.cards = cards;
                for (let id of ids) {
                    let found = false;
                    for (let card of parentCard.cards) {
                        if (card.id == id) {
                            parentCard = card;
                            found = true;
                        }
                    }

                    if (!found) {
                        error(`The ID ${ids.join("-")} does not exist!`);
                    }
                }
                return parentCard;
            }

            function cardsView() {
                const cardsDiv = document.createElement("div");
                cardsDiv.classList.add("cards")
                document.body.appendChild(cardsDiv);
                return cardsDiv;
            }

            // TODO: Change cover image based on content type
            // There are four content types: Nahw, qa'ida nahw, sarf, and qa'ida sarf
            function generateCardHTML(card) {
                let node;
                if (card.display === "cards") {
                    node = new DOMParser().parseFromString(`\
<a class="card big primary-bg" href="index.html?id=${ids.concat(card.id).join("-")}">
    <img src="img/nahw.jpg" alt="Nahw Image">
    <div class="card-container">
        <div class="card-title-type-container">
            <h1 class="card-title" lang="ar">${card.title}</h1>
            <p class="card-type" lang="ar">${card.type}</p>
        </div>
        <p class="card-description">${card.description}</p>
    </div>
</a>`, "text/html").body.firstElementChild;
                } else if (card.display === "question") {
                    node = new DOMParser().parseFromString(`\
<a class="card small secondary-bg" href="index.html?id=${ids.concat(card.id).join("-")}">
    <h1 class="card-title" lang="ar">${card.title}</h1>
</a>`, "text/html").body.firstElementChild;                    
                } else {
                    error(`Card ${card.id}'s display is not supported!`);
                    return;
                }

                node.card = card;
                return node;
            }

            let ids = getIds();
            let parentCard = getCard(ids);
            let qs = null;
            let qv = null;

            if (ids.length === 0) {
                const cardsElement = cardsView();
                cards.forEach( x => {
                    if (!x.hidden) {
                        cardsElement.appendChild(generateCardHTML(x));
                    }
                });
            } else if (parentCard && parentCard.display == "cards") {
                const cardsElement = cardsView();
                parentCard.cards.forEach( x => {
                    if (!x.hidden) {
                        cardsElement.appendChild(generateCardHTML(x));
                    }
                });
            } else if (parentCard.display === "question") {
                qs = new NahwQuestion(parentCard.sentences);
                const el = document.createElement("nahw-question");
                el.bindToState(qs);
                document.body.appendChild(el);
            } else {
                error(`ID ${ids.join("-")} is not currently supported!`)
            }
        </script>
    </body>
</html>
